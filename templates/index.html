<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shared Public List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Public List</h1>

        <form id="add-form">
            <input type="text" id="item-input" placeholder="Type something..." required>
            <button type="submit">Add</button>
        </form>
        
        <ul id="list">
            {% for id, item in items %}
                <li data-id="{{ id }}">
                    {{ item }}
                    <button onclick="deleteItem({{ id }})">Delete</button>
                </li>
            {% endfor %}
        </ul>
        

        <button id="clear-button" style="margin-top: 1rem; background: red;">
            Delete All
        </button>
    </div>

    <script>
        const form = document.getElementById('add-form');
        const input = document.getElementById('item-input');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch('/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item: input.value })
            });

            if (response.ok) {
                const result = await response.json();
                const li = document.createElement('li');
                li.textContent = result.item + ' ';
                li.setAttribute('data-id', result.id);
                
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.onclick = () => deleteItem(result.id);
                
                li.appendChild(delBtn);
                document.getElementById('list').appendChild(li);
                input.value = '';
            }
        });

        document.getElementById('clear-button').addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete everything?')) {
                const res = await fetch('/clear', { method: 'POST' });
                if (res.ok) {
                    document.getElementById('list').innerHTML = '';
                }
            }
        });

        function deleteItem(id) {
            fetch(`/delete/${id}`, { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        const li = document.querySelector(`li[data-id='${id}']`);
                        if (li) li.remove();
                    }
                });
        }
        
        let lastItemCount = document.querySelectorAll('#list li').length;

        setInterval(async () => {
            const res = await fetch('/items');
            const items = await res.json();

            if (items.length !== lastItemCount) {
                const list = document.getElementById('list');
                list.innerHTML = '';  // Clear current list

                items.forEach(([id, item]) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-id', id);
                    li.textContent = item + ' ';

                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.onclick = () => deleteItem(id);

                    li.appendChild(delBtn);
                    list.appendChild(li);
                });

                lastItemCount = items.length;
            }
        }, 2000); // every 2 seconds

        
        
    </script>
</body>
</html>
