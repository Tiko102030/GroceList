<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Общий Список</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Общий Список</h1>

        <form id="add-form">
            <input type="text" id="item-input" placeholder="Напишите пункт..." required>
            <input type="number" id="count-input" value="1" min="1" required style="width: 70px;">
            <button type="submit">Добавить</button>
        </form>
        

        <label for="sort-select">Сортировка:</label>
        <select id="sort-select">
            <option value="az">А → Я</option>
            <option value="za">Я → А</option>
            <option value="added">По времени добавки</option>
            <option value="amount">По количеству</option>
        </select>
        

        
        <ul id="list">
            {% for id, item in items %}
                <li data-id="{{ id }}">
                    {{ item }}
                    <button onclick="deleteItem({{ id }})">Удалить</button>
                </li>
            {% endfor %}
        </ul>
        

        <button id="clear-button" style="margin-top: 1rem; background: red;">
            Удалить Все
        </button>
    </div>

    <script>
        const form = document.getElementById('add-form');
        const input = document.getElementById('item-input');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const count = document.getElementById('count-input').value;

            const response = await fetch('/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item: input.value, count: count })
            });

            if (response.ok) {
                const result = await response.json();
                const li = document.createElement('li');
                li.setAttribute('data-id', result.id); // Use result.id here, not undefined or an old id

                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = 'space-between';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '1rem';

                // Left side: item + count (if count > 1)
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '0.5rem';

                const itemName = document.createElement('span');
                itemName.textContent = result.item;
                itemName.style.fontWeight = '500';

                left.appendChild(itemName);

                const countValue = result.count;
                if (parseInt(countValue) > 1) {
                    const countSpan = document.createElement('span');
                    countSpan.textContent = `× ${countValue}`;
                    countSpan.style.background = '#78ffb6';
                    countSpan.style.padding = '2px 6px';
                    countSpan.style.borderRadius = '5px';
                    countSpan.style.fontSize = '0.85rem';
                    countSpan.style.color = '#333';
                    left.appendChild(countSpan);
                }

                // Right side: delete button
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Удалить';
                delBtn.onclick = () => deleteItem(result.id);

                wrapper.appendChild(left);
                wrapper.appendChild(delBtn);
                li.appendChild(wrapper);
                document.getElementById('list').appendChild(li);

                // Clear input after adding the item
                input.value = '';
            }

            // You can still call fetchAndRenderList if you want periodic updates
            // fetchAndRenderList();
        });


        document.getElementById('clear-button').addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete everything?')) {
                const res = await fetch('/clear', { method: 'POST' });
                if (res.ok) {
                    document.getElementById('list').innerHTML = '';
                }
            }
        });

        function deleteItem(id) {
            fetch(`/delete/${id}`, { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        const li = document.querySelector(`li[data-id='${id}']`);
                        if (li) li.remove();
                    }
                });
        }
        
        let lastItemCount = document.querySelectorAll('#list li').length;

        async function fetchAndRenderList() {
            const sortOrder = document.getElementById('sort-select').value;
            const res = await fetch(`/items?sort=${sortOrder}`);
            const items = await res.json();
            const count = document.getElementById('count-input').value;

            const list = document.getElementById('list');
            list.innerHTML = ''; // Clear list every time

            items.forEach(([id, item, count]) => {
                const li = document.createElement('li');
                li.setAttribute('data-id', id || res.id);

                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = 'space-between';
                wrapper.style.alignItems = 'center';
                wrapper.style.gap = '1rem';

                // Left side: item + count (if count > 1)
                const left = document.createElement('div');
                left.style.display = 'flex';
                left.style.alignItems = 'center';
                left.style.gap = '0.5rem';

                const itemName = document.createElement('span');
                itemName.textContent = item || result.item;
                itemName.style.fontWeight = '500';

                left.appendChild(itemName);

                const countValue = count || result.count;
                if (parseInt(countValue) > 1) {
                    const countSpan = document.createElement('span');
                    countSpan.textContent = `× ${countValue}`;
                    countSpan.style.background = '#78ffb6';
                    countSpan.style.padding = '2px 6px';
                    countSpan.style.borderRadius = '5px';
                    countSpan.style.fontSize = '0.85rem';
                    countSpan.style.color = '#333';
                    left.appendChild(countSpan);
                }

                // Right side: delete button
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Удалить';
                delBtn.onclick = () => deleteItem(id || result.id);

                wrapper.appendChild(left);
                wrapper.appendChild(delBtn);
                li.appendChild(wrapper);

                list.appendChild(li);

            });

            lastItemCount = items.length;
        }

        setInterval(fetchAndRenderList, 20000);
        
        document.getElementById('sort-select').addEventListener('change', fetchAndRenderList);        
        


        fetchAndRenderList();
        
    </script>
</body>
</html>
